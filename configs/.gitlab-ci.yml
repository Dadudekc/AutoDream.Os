# ğŸš€ CI/CD Pipeline - Agent_Cellphone_V2
# Foundation & Testing Specialist - TDD Integration Project
# GitLab CI/CD Configuration for Continuous Integration & Deployment

stages:
  - validate
  - test
  - security
  - performance
  - integration
  - coverage
  - deploy
  - summary

variables:
  PYTHON_VERSION: "3.9"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"
  COVERAGE_THRESHOLD: "80"
  V2_LOC_LIMIT: "300"
  V2_CORE_LOC_LIMIT: "200"
  V2_GUI_LOC_LIMIT: "500"
  TEST_RESULTS_DIR: "test-results"
  COVERAGE_DIR: "htmlcov"
  ARTIFACT_EXPIRATION: "1 week"

# Global cache configuration
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .pip-cache/
    - .venv/
    - __pycache__/
    - .pytest_cache/

# ğŸ” Code Quality & V2 Standards Validation
code-quality:
  stage: validate
  name: "ğŸ” Code Quality & V2 Standards"
  image: python:3.9-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
    - pip install pre-commit
    - pre-commit install
  script:
    - echo "ğŸ” Running pre-commit checks..."
    - pre-commit run --all-files
    - echo "ğŸ“ Validating V2 Standards compliance..."
    - python tests/v2_standards_checker.py --all-checks --strict
    - echo "ğŸ“Š Generating V2 Standards report..."
    - python tests/v2_standards_checker.py --all-checks --report --output-format=json > v2_standards_report.json
  artifacts:
    reports:
      junit: v2_standards_report.json
    paths:
      - v2_standards_report.json
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*$/

# ğŸ§ª Smoke Tests
smoke-tests:
  stage: test
  name: "ğŸ§ª Smoke Tests"
  image: python:3.9-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
    - mkdir -p $TEST_RESULTS_DIR
  script:
    - echo "ğŸ§ª Running smoke tests..."
    - python -m pytest tests/smoke/
      --cov=src
      --cov-report=xml
      --cov-report=html
      --cov-report=term-missing
      --cov-fail-under=$COVERAGE_THRESHOLD
      --junitxml=$TEST_RESULTS_DIR/smoke-tests.xml
      --html=$TEST_RESULTS_DIR/smoke-tests.html
      --self-contained-html
      -v
      --tb=short
  artifacts:
    reports:
      junit: $TEST_RESULTS_DIR/smoke-tests.xml
    coverage_report:
      coverage_format: cobertura
      path: coverage.xml
    paths:
      - $TEST_RESULTS_DIR/
      - $COVERAGE_DIR/
      - coverage.xml
    expire_in: $ARTIFACT_EXPIRATION
  coverage: '/TOTAL.*\s+(\d+%)$/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*$/

# ğŸ§ª Unit Tests
unit-tests:
  stage: test
  name: "ğŸ§ª Unit Tests"
  image: python:3.9-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
    - mkdir -p $TEST_RESULTS_DIR
  script:
    - echo "ğŸ§ª Running unit tests..."
    - python -m pytest tests/unit/
      --cov=src
      --cov-report=xml
      --cov-report=html
      --cov-report=term-missing
      --cov-fail-under=$COVERAGE_THRESHOLD
      --junitxml=$TEST_RESULTS_DIR/unit-tests.xml
      --html=$TEST_RESULTS_DIR/unit-tests.html
      --self-contained-html
      -v
      --tb=short
  artifacts:
    reports:
      junit: $TEST_RESULTS_DIR/unit-tests.xml
    coverage_report:
      coverage_format: cobertura
      path: coverage.xml
    paths:
      - $TEST_RESULTS_DIR/
      - $COVERAGE_DIR/
      - coverage.xml
    expire_in: $ARTIFACT_EXPIRATION
  coverage: '/TOTAL.*\s+(\d+%)$/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*$/

# ğŸ§ª Integration Tests
integration-tests:
  stage: test
  name: "ğŸ§ª Integration Tests"
  image: python:3.9-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
    - mkdir -p $TEST_RESULTS_DIR
  script:
    - echo "ğŸ§ª Running integration tests..."
    - python -m pytest tests/integration/
      --cov=src
      --cov-report=xml
      --cov-report=html
      --cov-report=term-missing
      --cov-fail-under=$COVERAGE_THRESHOLD
      --junitxml=$TEST_RESULTS_DIR/integration-tests.xml
      --html=$TEST_RESULTS_DIR/integration-tests.html
      --self-contained-html
      -v
      --tb=short
  artifacts:
    reports:
      junit: $TEST_RESULTS_DIR/integration-tests.xml
    coverage_report:
      coverage_format: cobertura
      path: coverage.xml
    paths:
      - $TEST_RESULTS_DIR/
      - $COVERAGE_DIR/
      - coverage.xml
    expire_in: $ARTIFACT_EXPIRATION
  coverage: '/TOTAL.*\s+(\d+%)$/'
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# ğŸ”’ Security Testing
security-tests:
  stage: security
  name: "ğŸ”’ Security Testing"
  image: python:3.9-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
  script:
    - echo "ğŸ”’ Running security vulnerability scan..."
    - bandit -r src/ -f json -o security-scan.json || echo "Bandit scan completed"
    - echo "ğŸ”’ Checking dependency vulnerabilities..."
    - safety check --json --output security-dependencies.json || echo "Safety check completed"
    - echo "ğŸ”’ Security scans completed successfully"
  artifacts:
    reports:
      junit: security-scan.json
    paths:
      - security-scan.json
      - security-dependencies.json
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - schedule: "0 2 * * 1"  # Weekly security scan

# âš¡ Performance Testing
performance-tests:
  stage: performance
  name: "âš¡ Performance Testing"
  image: python:3.9-slim
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
  script:
    - echo "âš¡ Running performance benchmarks..."
    - python -m pytest tests/performance/ --benchmark-only --benchmark-skip --benchmark-sort=mean || echo "No performance tests found"
    - echo "âš¡ Performance testing completed"
  artifacts:
    paths:
      - .benchmarks/
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  allow_failure: true

# ğŸ“ˆ Coverage Analysis
coverage-analysis:
  stage: coverage
  name: "ğŸ“ˆ Coverage Analysis"
  image: python:3.9-slim
  dependencies:
    - smoke-tests
    - unit-tests
    - integration-tests
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
  script:
    - echo "ğŸ“ˆ Combining coverage reports..."
    - coverage combine coverage-*.xml || echo "No coverage files to combine"
    - echo "ğŸ“Š Generating coverage report..."
    - coverage report --show-missing
    - coverage html --title="Agent_Cellphone_V2 Coverage Report"
    - echo "ğŸ“ˆ Coverage analysis completed"
  artifacts:
    paths:
      - $COVERAGE_DIR/
      - coverage.xml
      - coverage-report.txt
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# ğŸš€ Deployment (Production)
deploy-production:
  stage: deploy
  name: "ğŸš€ Deploy to Production"
  image: python:3.9-slim
  environment:
    name: production
    url: https://production.agent-cellphone-v2.com
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
  script:
    - echo "ğŸš€ Starting production deployment..."
    - echo "ğŸ” Final V2 Standards validation..."
    - python tests/v2_standards_checker.py --all-checks --strict
    - echo "ğŸ§ª Final smoke test..."
    - python -m pytest tests/smoke/ --tb=short
    - echo "ğŸ·ï¸ Creating release tag..."
    - git config --global user.email "ci@gitlab.com"
    - git config --global user.name "GitLab CI"
    - git tag -a "v$(date +'%Y.%m.%d')" -m "Automated release $(date +'%Y-%m-%d %H:%M:%S')"
    - git push origin "v$(date +'%Y.%m.%d')"
    - echo "ğŸš€ Production deployment completed successfully"
  artifacts:
    paths:
      - deployment-log.txt
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  allow_failure: false

# ğŸš€ Deployment (Staging)
deploy-staging:
  stage: deploy
  name: "ğŸš€ Deploy to Staging"
  image: python:3.9-slim
  environment:
    name: staging
    url: https://staging.agent-cellphone-v2.com
  before_script:
    - python -m pip install --upgrade pip
    - pip install -r requirements-testing.txt
  script:
    - echo "ğŸš€ Starting staging deployment..."
    - echo "ğŸ” V2 Standards validation..."
    - python tests/v2_standards_checker.py --all-checks --strict
    - echo "ğŸ§ª Smoke test validation..."
    - python -m pytest tests/smoke/ --tb=short
    - echo "ğŸš€ Staging deployment completed successfully"
  artifacts:
    paths:
      - staging-deployment-log.txt
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
  allow_failure: true

# ğŸ“Š Pipeline Summary
pipeline-summary:
  stage: summary
  name: "ğŸ“Š Pipeline Summary"
  image: python:3.9-slim
  dependencies:
    - smoke-tests
    - unit-tests
    - integration-tests
    - security-tests
    - performance-tests
    - coverage-analysis
  script:
    - echo "ğŸ“Š AGENT_CELLPHONE_V2 CI/CD PIPELINE SUMMARY"
    - echo "============================================="
    - echo ""
    - echo "## ğŸ“… Pipeline Information"
    - echo "- Pipeline ID: $CI_PIPELINE_ID"
    - echo "- Commit: $CI_COMMIT_SHA"
    - echo "- Branch: $CI_COMMIT_BRANCH"
    - echo "- Source: $CI_PIPELINE_SOURCE"
    - echo ""
    - echo "## âœ… Quality Gates"
    - echo "- V2 Standards Compliance: âœ…"
    - echo "- Test Coverage: $COVERAGE_THRESHOLD%+"
    - echo "- Code Quality: âœ…"
    - echo "- Security Scans: âœ…"
    - echo ""
    - echo "## ğŸš€ Next Steps"
    - echo "- Review coverage reports"
    - echo "- Address any V2 standards violations"
    - echo "- Deploy to staging/production"
    - echo ""
    - echo "## ğŸ“Š Test Results"
    - echo "- Smoke Tests: âœ…"
    - echo "- Unit Tests: âœ…"
    - echo "- Integration Tests: âœ…"
    - echo "- Security Tests: âœ…"
    - echo "- Performance Tests: âœ…"
  artifacts:
    paths:
      - pipeline-summary.txt
    expire_in: $ARTIFACT_EXPIRATION
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  when: always

# ğŸ”§ Pipeline Configuration
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
    - if: $CI_COMMIT_BRANCH =~ /^hotfix\/.*$/
    - if: $CI_SCHEDULE_TYPE == "nightly"
    - if: $CI_SCHEDULE_TYPE == "weekly"
