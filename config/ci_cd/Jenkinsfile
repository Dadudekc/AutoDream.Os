#!/usr/bin/env groovy

def cfg = load('config/ci_cd/config.groovy')

def buildStep = load('config/ci_cd/steps/build.groovy')
def testStep = load('config/ci_cd/steps/test.groovy')
def deployStep = load('config/ci_cd/steps/deploy.groovy')

pipeline {
    agent any

    environment {
        PYTHON_VERSION = cfg.pythonVersion
        TEST_RESULTS_DIR = "${env.WORKSPACE}/test-results"
        COVERAGE_DIR = "${env.WORKSPACE}/htmlcov"
        COVERAGE_THRESHOLD = cfg.coverageThreshold
    }

    stages {
        stage('Build') {
            steps {
                script {
                    buildStep(cfg)
                }
            }
        }

        stage('Test') {
            steps {
                script {
                    testStep(cfg)
                }
            }
        }

        stage('Deploy') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                }
            }
            steps {
                script {
                    deployStep(cfg)
                }
            }
        }
    }
}
