<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Health Monitor - Agent Cellphone V2</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>

    <style>
        :root {
            --primary-color: #0d6efd;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
            --dark-color: #212529;
            --light-color: #f8f9fa;
        }

        body {
            background-color: var(--light-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .health-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
        }

        .health-card:hover {
            transform: translateY(-2px);
        }

        .status-excellent { background: linear-gradient(135deg, #d4edda, #c3e6cb); }
        .status-good { background: linear-gradient(135deg, #d1ecf1, #bee5eb); }
        .status-warning { background: linear-gradient(135deg, #fff3cd, #ffeaa7); }
        .status-critical { background: linear-gradient(135deg, #f8d7da, #f5c6cb); }
        .status-offline { background: linear-gradient(135deg, #e2e3e5, #d6d8db); }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }

        .metric-unit {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .alert-card {
            border-left: 4px solid;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-critical { border-left-color: var(--danger-color); }
        .alert-warning { border-left-color: var(--warning-color); }
        .alert-info { border-left-color: var(--info-color); }

        .health-score {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 1rem 0;
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .agent-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .agent-item {
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .agent-item:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-heart-pulse-fill me-2"></i>
                Agent Health Monitor
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <i class="bi bi-circle-fill text-success me-1"></i>
                    <span id="connection-status">Connected</span>
                </span>
            </div>
        </div>
    </nav>

    <!-- Connection Status -->
    <div class="connection-status">
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <i class="bi bi-wifi me-2"></i>
            <span id="connection-detail">Establishing connection...</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close" aria-label="Close"></button>
        </div>
    </div>

    <!-- Refresh Indicator -->
    <div class="refresh-indicator">
        <div class="alert alert-light alert-dismissible fade show" role="alert">
            <i class="bi bi-arrow-clockwise me-2"></i>
            <span id="last-update">Last update: Never</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close" aria-label="Close"></button>
        </div>
    </div>

    <div class="container-fluid mt-4">
        <!-- Health Summary Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card health-card text-center">
                    <div class="card-body">
                        <i class="bi bi-people-fill text-primary" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Total Agents</h5>
                        <p class="metric-value" id="total-agents">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card health-card text-center">
                    <div class="card-body">
                        <i class="bi bi-exclamation-triangle-fill text-warning" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Active Alerts</h5>
                        <p class="metric-value" id="active-alerts">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card health-card text-center">
                    <div class="card-body">
                        <i class="bi bi-graph-up text-success" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Avg Health Score</h5>
                        <p class="metric-value" id="avg-health-score">-</p>
                        <small class="metric-unit">out of 100</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card health-card text-center">
                    <div class="card-body">
                        <i class="bi bi-activity text-info" style="font-size: 2rem;"></i>
                        <h5 class="card-title mt-2">Monitoring Status</h5>
                        <p class="metric-value" id="monitoring-status">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Column: Agent Health -->
            <div class="col-md-8">
                <div class="card health-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check me-2"></i>
                            Agent Health Overview
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshAgentHealth()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="agent-health-container">
                            <div class="text-center py-4">
                                <div class="loading-spinner"></div>
                                <p class="mt-2">Loading agent health data...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Health Metrics Chart -->
                <div class="card health-card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up me-2"></i>
                            Health Metrics Trend
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="healthMetricsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Alerts and Details -->
            <div class="col-md-4">
                <!-- Health Alerts -->
                <div class="card health-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Health Alerts
                        </h5>
                        <span class="badge bg-danger" id="alert-count">0</span>
                    </div>
                    <div class="card-body">
                        <div id="alerts-container">
                            <p class="text-muted text-center">No active alerts</p>
                        </div>
                    </div>
                </div>

                <!-- Status Distribution -->
                <div class="card health-card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart me-2"></i>
                            Status Distribution
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="statusDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card health-card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning me-2"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="exportHealthReport()">
                                <i class="bi bi-download me-2"></i>
                                Export Report
                            </button>
                            <button class="btn btn-outline-warning" onclick="acknowledgeAllAlerts()">
                                <i class="bi bi-check-all me-2"></i>
                                Acknowledge All
                            </button>
                            <button class="btn btn-outline-info" onclick="refreshAllData()">
                                <i class="bi bi-arrow-clockwise me-2"></i>
                                Refresh All
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Global variables
        let socket;
        let healthMetricsChart;
        let statusDistributionChart;
        let lastUpdateTime = new Date();
        let updateInterval;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            initializeCharts();
            loadInitialData();
            startAutoRefresh();
        });

        // Initialize WebSocket connection
        function initializeSocket() {
            socket = io();

            socket.on('connect', function() {
                updateConnectionStatus('Connected', 'success');
                socket.emit('subscribe_to_health_updates');
            });

            socket.on('disconnect', function() {
                updateConnectionStatus('Disconnected', 'danger');
            });

            socket.on('health_update', function(data) {
                updateDashboardData(data);
            });

            socket.on('periodic_update', function(data) {
                updateDashboardData(data);
            });

            socket.on('error', function(data) {
                console.error('Socket error:', data);
                showNotification('Error: ' + data.message, 'danger');
            });
        }

        // Initialize charts
        function initializeCharts() {
            // Health Metrics Chart
            const healthCtx = document.getElementById('healthMetricsChart').getContext('2d');
            healthMetricsChart = new Chart(healthCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Average Health Score',
                        data: [],
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        }
                    }
                }
            });

            // Status Distribution Chart
            const statusCtx = document.getElementById('statusDistributionChart').getContext('2d');
            statusDistributionChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Excellent', 'Good', 'Warning', 'Critical', 'Offline'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#198754',
                            '#0d6efd',
                            '#ffc107',
                            '#dc3545',
                            '#6c757d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load initial data
        function loadInitialData() {
            Promise.all([
                fetch('/api/health/summary'),
                fetch('/api/health/agents'),
                fetch('/api/health/alerts'),
                fetch('/api/health/status')
            ]).then(responses => {
                return Promise.all(responses.map(r => r.json()));
            }).then(([summary, agents, alerts, status]) => {
                updateDashboardData({
                    health_summary: summary,
                    agents: agents,
                    alerts: alerts,
                    status: status
                });
            }).catch(error => {
                console.error('Error loading initial data:', error);
                showNotification('Error loading data', 'danger');
            });
        }

        // Update dashboard data
        function updateDashboardData(data) {
            if (data.health_summary) {
                updateSummaryCards(data.health_summary);
            }

            if (data.agents) {
                updateAgentHealth(data.agents);
            }

            if (data.alerts) {
                updateAlerts(data.alerts);
            }

            if (data.status) {
                updateStatusInfo(data.status);
            }

            lastUpdateTime = new Date();
            updateLastUpdateTime();
        }

        // Update summary cards
        function updateSummaryCards(summary) {
            document.getElementById('total-agents').textContent = summary.total_agents || 0;
            document.getElementById('active-alerts').textContent = summary.active_alerts || 0;
            document.getElementById('avg-health-score').textContent = summary.average_health_score || 0;
            document.getElementById('monitoring-status').textContent = summary.monitoring_active ? 'Active' : 'Inactive';

            // Update status distribution chart
            if (summary.status_distribution) {
                const statusData = [
                    summary.status_distribution.excellent || 0,
                    summary.status_distribution.good || 0,
                    summary.status_distribution.warning || 0,
                    summary.status_distribution.critical || 0,
                    summary.status_distribution.offline || 0
                ];

                statusDistributionChart.data.datasets[0].data = statusData;
                statusDistributionChart.update();
            }
        }

        // Update agent health display
        function updateAgentHealth(agents) {
            const container = document.getElementById('agent-health-container');

            if (!agents || Object.keys(agents).length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No agents found</p>';
                return;
            }

            let html = '<div class="agent-list">';

            Object.values(agents).forEach(agent => {
                const statusClass = `status-${agent.overall_status}`;
                const statusBadgeClass = getStatusBadgeClass(agent.overall_status);

                html += `
                    <div class="agent-item ${statusClass}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${agent.agent_id}</h6>
                                <small class="text-muted">
                                    Last update: ${new Date(agent.timestamp).toLocaleTimeString()}
                                </small>
                            </div>
                            <div class="text-end">
                                <span class="badge ${statusBadgeClass} status-badge">
                                    ${agent.overall_status.toUpperCase()}
                                </span>
                                <div class="health-score text-${getHealthScoreColor(agent.health_score)}">
                                    ${Math.round(agent.health_score)}
                                </div>
                            </div>
                        </div>
                        ${agent.recommendations && agent.recommendations.length > 0 ? `
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="bi bi-lightbulb me-1"></i>
                                    ${agent.recommendations.join(', ')}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Update alerts display
        function updateAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            const alertCount = document.getElementById('alert-count');

            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No active alerts</p>';
                alertCount.textContent = '0';
                return;
            }

            alertCount.textContent = alerts.length;

            let html = '';
            alerts.forEach(alert => {
                const alertClass = `alert-${alert.severity}`;
                const severityIcon = getSeverityIcon(alert.severity);

                html += `
                    <div class="alert ${alertClass} alert-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="alert-heading">
                                    ${severityIcon} ${alert.agent_id}
                                </h6>
                                <p class="mb-1">${alert.message}</p>
                                <small class="text-muted">
                                    ${new Date(alert.timestamp).toLocaleString()}
                                </small>
                            </div>
                            <div class="ms-2">
                                ${!alert.acknowledged ? `
                                    <button class="btn btn-sm btn-outline-primary" onclick="acknowledgeAlert('${alert.alert_id}')" title="Acknowledge Alert" aria-label="Acknowledge Alert">
                                        <i class="bi bi-check"></i>
                                    </button>
                                ` : ''}
                                ${!alert.resolved ? `
                                    <button class="btn btn-sm btn-outline-success" onclick="resolveAlert('${alert.alert_id}')" title="Resolve Alert" aria-label="Resolve Alert">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update status information
        function updateStatusInfo(status) {
            // Update any status-specific information
            if (status.monitoring_active !== undefined) {
                const monitoringElement = document.getElementById('monitoring-status');
                monitoringElement.textContent = status.monitoring_active ? 'Active' : 'Inactive';
                monitoringElement.className = `metric-value text-${status.monitoring_active ? 'success' : 'danger'}`;
            }
        }

        // Utility functions
        function getStatusBadgeClass(status) {
            const statusClasses = {
                'excellent': 'bg-success',
                'good': 'bg-primary',
                'warning': 'bg-warning',
                'critical': 'bg-danger',
                'offline': 'bg-secondary'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        function getHealthScoreColor(score) {
            if (score >= 90) return 'success';
            if (score >= 75) return 'primary';
            if (score >= 50) return 'warning';
            return 'danger';
        }

        function getSeverityIcon(severity) {
            const icons = {
                'critical': '<i class="bi bi-exclamation-triangle-fill text-danger"></i>',
                'warning': '<i class="bi bi-exclamation-triangle text-warning"></i>',
                'info': '<i class="bi bi-info-circle text-info"></i>'
            };
            return icons[severity] || '<i class="bi bi-info-circle text-info"></i>';
        }

        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connection-status');
            const detailElement = document.getElementById('connection-detail');

            statusElement.textContent = status;
            detailElement.textContent = status;

            // Update connection status indicator
            const indicator = document.querySelector('.connection-status .alert');
            indicator.className = `alert alert-${type} alert-dismissible fade show`;
        }

        function updateLastUpdateTime() {
            const element = document.getElementById('last-update');
            element.textContent = `Last update: ${lastUpdateTime.toLocaleTimeString()}`;
        }

        // Action functions
        function acknowledgeAlert(alertId) {
            fetch(`/api/health/alerts/${alertId}/acknowledge`, {
                method: 'POST'
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Alert acknowledged', 'success');
                    refreshAllData();
                } else {
                    showNotification('Error acknowledging alert', 'danger');
                }
            }).catch(error => {
                console.error('Error acknowledging alert:', error);
                showNotification('Error acknowledging alert', 'danger');
            });
        }

        function resolveAlert(alertId) {
            fetch(`/api/health/alerts/${alertId}/resolve`, {
                method: 'POST'
            }).then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification('Alert resolved', 'success');
                    refreshAllData();
                } else {
                    showNotification('Error resolving alert', 'danger');
                }
            }).catch(error => {
                console.error('Error resolving alert:', error);
                showNotification('Error resolving alert', 'danger');
            });
        }

        function acknowledgeAllAlerts() {
            if (confirm('Are you sure you want to acknowledge all alerts?')) {
                // This would need to be implemented on the backend
                showNotification('Feature not yet implemented', 'info');
            }
        }

        function exportHealthReport() {
            showNotification('Export feature not yet implemented', 'info');
        }

        function refreshAgentHealth() {
            fetch('/api/health/agents')
                .then(response => response.json())
                .then(agents => updateAgentHealth(agents))
                .catch(error => {
                    console.error('Error refreshing agent health:', error);
                    showNotification('Error refreshing data', 'danger');
                });
        }

        function refreshAllData() {
            loadInitialData();
        }

        function startAutoRefresh() {
            updateInterval = setInterval(() => {
                if (socket.connected) {
                    socket.emit('request_health_update');
                }
            }, 30000); // Refresh every 30 seconds
        }

        function showNotification(message, type) {
            // Simple notification system
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.top = '80px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '1050';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" title="Close" aria-label="Close"></button>
            `;

            document.body.appendChild(alertDiv);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (socket) {
                socket.disconnect();
            }
        });
    </script>
</body>
</html>
